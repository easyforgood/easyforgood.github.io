接口中心
========

替代U盾


1. register 注册事务号 拿到token

2. pre-auth 校验 token 用户信息 校验合法性

 preauth返回认证列表

OTP 数字令 

push

face

 ？ 
3. chooseauthtype
选择
组装上下文

4. Auth 
具体认证
事务超时


5. getbase

获取事务信息

关闭事务



后台worker自动检测事务超时或者没有掉getbase

6.  查询 信息


7.  getpush 

推送确认 拉取真正的消息



#####想法

接口统计如何实现

1. register 接口

deviceid 设备

systemno 系统编码/公司编码

appid 业务系统编号 由于appid之前对应多个业务系统 导致新增了 systemno

scenarioid 场景id 区分登录、购买。区分认证策略 

用户信息都存在 接口中心里面 请开通HUE绑定


Test HUE register
	Given request data
		When 解析数据
		When 检验数据 主要是拉取数据
			When 查询业务系统编码Systemno
		 	When 检验appid
		 	When 校验scenarioid
		 When 生成并保存txid
		 When 组装上下文context 根据场景配置认证策略
		 When 根据帐号判断 是快捷登录
		 	Then  根据did判断认证策略
		 	Then 直接具体登录
		 When 根据帐号判断 不是快捷登录
            Then 上下文放到缓存里面
        Then 返回txid

### PreAuth
register -> PreAuth
认证前的校验
input: token
dcCode 时空码 ?? 网页没有 ？？？
clientType 客户端类型

1. 还原txcode

2. 上下文拿出来

3。 dccode不会空 校验vaildcode 校验发起设备 获取did

3.1 检验后 用户安全策略表 用户校验失败次数 不是一次tx需要 判断是否超出校验次数

3.2 查认证列表  根据client类型判断 取 认证方式列表

3.3 快捷登录判断 不需要绑定设备

3.4 没有绑定报错 走绑定流程

3.5 取绑定列表

3.5.1 校验当前did是否为绑定设备 否则失败


### chooseauthtype

获取 上下文

校验认证方式有没有存在context中

是否需要设置人脸

txlog设置 authType
context start 启动上下文

推送逻辑 did 和  绑定设备 

只保存不推送（？？？）

人脸 推送  

return nextAuth

### PreBind
registerToken -> PreBind 

### PreSetFace
registerToken -> PreSetFace


### Premodify



###具体Auth 

doBefore 校验

doAfter nextAuth