
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Linux内核分析作业6：分析Linux内核创建一个新进程的过程</title>
    
    <meta name="author" content="siplexy">

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Bootstrap styles -->
    <link href="/assets/themes/bootstrap-3/bootstrap/css/bootstrap.min.css" rel="stylesheet">
   <!--  <link href="/assets/themes/bootstrap-3/css/prettify.css" rel="stylesheet"> -->
   <link rel="stylesheet" href="/assets/themes/bootstrap-3/css/zenburn.css">
    <!-- Optional theme -->
    <link href="/assets/themes/bootstrap-3/bootstrap/css/bootstrap-theme.min.css" rel="stylesheet">
    <!-- Sticky Footer -->
    <link href="/assets/themes/bootstrap-3/bootstrap/css/bs-sticky-footer.css" rel="stylesheet">
    
    <!-- Custom styles -->
    <link href="/assets/themes/bootstrap-3/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <!-- Update these with your own images
      <link rel="shortcut icon" href="images/favicon.ico">
      <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
      <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
      <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
    -->

    <!-- atom & rss feed -->
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">

  </head>

  <body>
    <div id="wrap">
      <nav class="navbar navbar-default" role="navigation">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#jb-navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">Sip 桑 的 Blog~ ^。^</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="jb-navbar-collapse">
          <ul class="nav navbar-nav">
            
            
            


  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/archive.html">Archive</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/categories.html">Categories</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/pages.html">Pages</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags.html">Tags</a></li>
      	
      
    
  



          </ul>
          <form class="navbar-form navbar-right" role="search">
            <div class="form-group">
              <input type="text" class="form-control" placeholder="Search">
            </div>
            <button type="submit" class="btn btn-default">Submit</button>
          </form>
        </div><!-- /.navbar-collapse -->
      </nav>

      <div class="container">
        
<div class="page-header">
  <h1>Linux内核分析作业6：分析Linux内核创建一个新进程的过程 </h1>
</div>

<div class="row">
  <div class="col-xs-12">
    <h4>朋翔 原创作品转载请注明出处《Linux内核分析》MOOC课程http://mooc.study.163.com/course/USTC-1000029000</h4>

<hr>

<h3>一、过程整理</h3>

<p>这里的过程大致上和<a href="https://easyforgood.github.io/Linux_3">第三次实验</a>类似</p>

<p>具体不同就是需要将test_fork.c 替换为 test.c即可。</p>

<p>另外设置断点是现在 run<em>init</em>process 设置了一个。</p>

<p>然后再设置do_fork那些。</p>

<p>不然半个小时之后才能进入想要的。</p>

<h3>二、关于task_struct 结构</h3>

<p>找到了这篇博客还是挺好的。介绍的很详细和全面</p>

<p><a href="http://blog.csdn.net/npy_lp/article/details/7292563">Linux进程管理之task_struct结构体（上）</a></p>

<p><a href="http://blog.csdn.net/npy_lp/article/details/7335187">Linux进程管理之task_struct结构体（下）</a></p>

<p>简单总结一下和 进程管理、内存管理、文件系统有关的主要部分:</p>

<ol>
<li><p>进程状态 </p>
<div class="highlight"><pre><code class="language-text" data-lang="text">volatile long state;  
int exit_state;
</code></pre></div></li>
</ol>

<p>这张图很经典：</p>

<p><img src="http://my.csdn.net/uploads/201204/14/1334337470_8447.jpg" alt="enter image description here"></p>

<ol>
<li><p>进程标识符</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">/*一般情况 32768 个进程*/
pid_t pid;  
/*线程组的领头线程 getpid()返回值*/
pid_t tgid;  
</code></pre></div></li>
<li><p>进程调度 </p>
<div class="highlight"><pre><code class="language-text" data-lang="text">/* prio用于保存动态优先级 static_prio静态优先级 normal_prio的值取决于静态优先级和调度策略*/
int prio, static_prio, normal_prio; 
/*实时优先级*/ 
unsigned int rt_priority;  
/*调度类*/
const struct sched_class *sched_class;  
？/*普通进程调用实体*/
struct sched_entity se;
？/*实时进程调用实体*/  
struct sched_rt_entity rt;  
/*调度策略*/
unsigned int policy;  
/*控制进程可以在哪里处理器上运行*/
cpumask_t cpus_allowed;     
</code></pre></div></li>
<li><p>进程内核栈</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">/*指向下面的内核栈结构体的“栈底”*/
void *stack;

/*内核栈结构体*/
union thread_union {  
        struct thread_info thread_info;  
        unsigned long stack[THREAD_SIZE/sizeof(long)];  //内核栈大小为THREAD_SIZE 一般为8K
};  
</code></pre></div>
<p><img src="http://blog.chinaunix.net/attachment/201111/4/20543672_13203954065UzM.jpeg" alt="enter image description here"></p></li>
<li><p>进程地址空间 </p>
<div class="highlight"><pre><code class="language-text" data-lang="text">    /*mm指向进程所拥有的内存描述符。active_mm表示所使用的内存描述符*/
    struct mm_struct *mm, *active_mm;
    /*记录堆栈随机化的信息，为了安全引入的*/
    unsigned brk_randomized:1;
    /*进程缓存相关*/
    struct task_rss_stat    rss_stat;
</code></pre></div></li>
<li><p>文件</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">/* 和文件系统相关的信息*/  
int link_count, total_link_count;  
/* 进程当前和跟目录 */  
struct fs_struct *fs;  
/* 已打开文件表*/  
struct files_struct *files;  
</code></pre></div></li>
</ol>

<h3>三、 创建一个新进程的过程</h3>

<p>整体流程：</p>

<p><img src="./linux6/lab1.png" alt="enter image description here"></p>

<p>解释我遇到的两个问题：</p>

<p>第一个问题是 创建子进程之后是如何调度的？</p>

<p>其实上述流程图所示。</p>

<p>一般情况下。先运行父进程，在运行子进程。</p>

<p>父进程在给子进程的thread<em>struct中的ip 赋了ret</em>from_fork后。</p>

<p>他走完整个do<em>fork（）后，会回到系统调用syscall</em>exit退出。</p>

<p>还记得系统调用最后会进行调度。</p>

<p>调度到子进程。</p>

<p>这时候子进程从ret<em>from</em>fork执行后，也会进入syscall_exit </p>

<p>又重新进行了调度，把控制权交给了父进程。</p>

<p>所以先进行父进程的输出</p>

<p>（注：这只是我看代码的一种理解。我在猜想也有可能进程不进行调度）</p>

<hr>

<p>第二个问题: 内存是怎么分配的。</p>

<p>这里涉及到了发现了两个知识点。</p>

<p>一个是伙伴系统进行内存分配。一个是slab分配器。</p>

<p>在dup<em>task</em>struct  中实现的。</p>

<p>为task<em>struct 和 thread</em>info 开辟内存</p>

<p>thread_info 就是之前有提过的内核栈。 具体情况见上图。</p>

<p>tsk = alloc<em>task</em>struct_node(node); </p>

<p>ti = alloc<em>thread</em>info_node(tsk, node);</p>

<p>这里 由于两个 数据结构 较小，而且分配的时候内存长度不变。因此都是slab分配器分配的。</p>

<p>主要是这两个地方要重新分配。</p>

<p>其他的地方通过copy_MM()共享同一空间就可以了。</p>

<hr>

<p>最后说一下我对整个调用栈的理解。</p>

<p>copy<em>process() 中的copy</em>thread() </p>

<p>thread<em>struct 这个结构非常重要
，里面其实就是一个类似于pt</em>regs 这个数据结构，记录和处理器相关的寄存器的值。</p>

<p>(注：我去查一下之前的内核版本信息。发现这个 task<em>strutct 中的thread</em>struct thread 这个属性在Linux2.4.16叫 thread_struct tss。 tss 啊！！百度一下你就知道是什么了 里面就是记录了任务状态！所以对应的ip就是之前用户空间的ip！)</p>

<p>进程切换的时候。
linux会恢复cpu的内容，所以thread-&gt;ip自然就被恢复到eip寄存器中了</p>

<p>同时 copy_thread 里面的ax也要赋值为0.这样才会通过返回值区分父子进程</p>

<h3>四、 总结</h3>

<p>仔细琢磨就会发现原来，fork的父子进程都是用同样的代码。</p>

<p>但是。。写不下去了。。。。看的太累了</p>

<hr>

  </div>
</div>




      </div>

    <!-- 多说评论框 start -->
  <div class="ds-thread" data-thread-key="" data-title="Sip 桑 的 Blog~ ^。^" data-url=""></div>
<!-- 多说评论框 end -->
<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"easyforgood"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
  </script>
<!-- 多说公共JS代码 end -->


    </div>

    <div id="footer">
      <div class="container">
        <p>&copy; 2015 siplexy
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
        </p>
      </div>
    </div>

    


    <!-- Latest compiled and minified JavaScript, requires jQuery 1.x (2.x not supported in IE8) -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="/assets/themes/bootstrap-3/bootstrap/js/bootstrap.min.js"></script>
    <script src="/assets/themes/bootstrap-3/js/prettify.js"></script>
    <script src="/assets/themes/bootstrap-3/js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

  </body>
</html>



